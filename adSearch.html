<!DOCTYPE html>
<html lang="en">

<head>
    <title>SALES24</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="icon" type="image/png" href="images/favicon.png" />
    <style>
        body {
            background-color: #EBEDEF;
        }

        hr {
            border: 0;
            clear: both;
            display: block;
            width: 96%;
            background-color: grey;
            height: 1px;
        }

        p {
            overflow: hidden;
            white-space: nowrap;
        }

        .border-primary {
            border: 1px solid grey;
            padding: 20px;
        }

        .w3-card-4 {
            object-fit: cover;
            margin: 5px;
            padding: 5px
        }

        img {
            width: 100% !important;
            height: 200px !important;
            object-fit: cover;
            border: 1px solid #ddd;
            /* Gray border */
            border-radius: 4px;
            /* Rounded border */
            padding: 5px;
            /* Some padding */
            width: 150px;
            /* Set a small width */
            object-fit: cover;
        }

        /* Center the loader */
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Add animation to "page content" */
        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }

            to {
                bottom: 0px;
                opacity: 1
            }
        }

        @keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }

            to {
                bottom: 0;
                opacity: 1
            }
        }

        #myDiv {
            display: none;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="loader" style="display: none;"></div>
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index1.html">SALES24.com</a>
            </div>
            <ul class="nav navbar-nav">
                <li><a href="index1.html">Home</a></li>
                <li><a href="deals.html">DEALS</a></li>
                <li><a href="#">ABOUT</a></li>
                <li><a href="#">CONTACT</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right" id="userNotLoggedIn">
                <li><a href="register.html"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                <li><a href="javascript:void(0)" onclick="login()"><span class="glyphicon glyphicon-log-in"></span>
                        Login</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right" id="userLogin" style="display: none;">
                <li class="navbar-text" id="lastLogin"></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userActions" data-toggle="dropdown" href="#"
                        role="button" aria-haspopup="true" aria-expanded="false">
                        Hi,User
                    </a>
                    <ul class="dropdown-menu">
                        <li><a href="profile.html">Profile</a></li>
                        <li><a href="postAd.html">Post AD</a></li>
                        <li><a href="#">AD's Posted</a></li>
                        <li><a href="javascript:void(0)" onclick="logout()">Logout</a></li>
                        <li><a href="javascript:void(0)" onclick="logoutAll()">Logout Of All Devices</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container border-primary" id="content" style="background-color: whitesmoke;">
        <button id="closeButton" name="recentltPostedAds" class="btn btn-primary" style="float:right;">Close</button>
        <br>
        <h3 class="font-weight-light mt-4 mb-0"><b id="pageHeading"></b></h3>
        <hr color="grey">
        <div id="productCategoryDiv" style="display: none;">
            <select id="productCategory" name="productCategory" class="form-control" style="float: right;width: 20%;">
                <option value="Electronics" selected>Electronics</option>
                <option value="Fashion">Fashion</option>
                <option value="Home Appliances">Home Appliances</option>
                <option value="Two Wheeler">Two Wheeler</option>
                <option value="Four Wheeler">Four Wheeler</option>
                <option value="Others">Others</option>
            </select>
            <br>
            <br>
            </div>

        <div class="row text-center text-lg-left" id="mainHead">
            <div class="col-lg-3 col-md-4 col-6"><a id="id" class="d-block mb-4 h-100" href="#">
                    <div class="w3-card-4">
                        <p class="text-lg-center">PRODUCT NAME<i></i></p><img class="w3-image" id="id"
                            src="images/logo.png" alt="images/logo.png">
                        <p class="text-lg-center">PRODUCT DESCRIPTION</p>
                        <p class="text-lg-center">â‚¹ <b>PRICE</b></p>
                    </div>
                </a></div>
            <p class="text-lg-center" id="noAds" style="display: none;"><i>Ads Posted Yet.</i><a href="postAd.html"
                    style="color: royalblue;">Post AD</a></p>
        </div>
        <br>
        <button id="searchMore" name="searchMore" class="btn btn-primary" style="float:right;display: none">See
            More</button>
        <center>
            <p class="text-lg-center" id="lastAd" style="display: none;"><i>No more Ads to display.</i><a
                    href="postAd.html" style="color: royalblue;">Post AD</a></p>
        </center>
    </div>
<br><br>
</body>
<script>
    var start = true;
    var starting=true;
    document.getElementById('closeButton').onclick = function () {
        window.location = "index1.html"
    };

    function login() {
        var requestedUrl = window.location
        sessionStorage.setItem('requestedURL', requestedUrl)
        window.location = "login.html"
    }

    var myIndex = 0;
    function readCookie(name) {
        var i, c, ca, nameEQ = name + "=";
        ca = document.cookie.split(';');
        for (i = 0; i < ca.length; i++) {
            c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1, c.length);
            }
            if (c.indexOf(nameEQ) == 0) {
                return c.substring(nameEQ.length, c.length);
            }
        }
        return '';
    }
    var delete_cookie = function (name) {
        document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    };
    if (readCookie("_sales24JWT") != "") {
        document.getElementById('userNotLoggedIn').style.display = "none"
        document.getElementById('userLogin').style.display = "block"
        var user_data = JSON.parse(readCookie("_sales24JWT"))
        document.getElementById("userActions").innerHTML = "Hi, " + user_data.username,
            document.getElementById("lastLogin").innerHTML = "Last Login: " + user_data.lastLogin
    }

    function logout() {
        var logout_confirm = confirm("Do you wish to logout?")
        if (logout_confirm) {
            const url = "https://8xmv9zllk6.execute-api.us-east-1.amazonaws.com/DEV/me/logout"
            document.getElementById("loader").style.display = "block";
            var logout_operation = async () => await fetch(url, {
                Host: "8xmv9zllk6.execute-api.us-east-1.amazonaws.com",
                method: 'GET',
                headers: {
                    'Content-Type': 'application/text',
                    'Authorization': user_data.Token
                }
            }).then((res) => {
                return res.text().then((data) => {
                    alert("You Have successfully Logged out of current session.")
                    delete_cookie("_sales24JWT")
                    window.location = 'index1.html';
                })
            }).catch((err) => {
                alert("Something went wrong. Please login Again")
                delete_cookie("_sales24JWT")
                window.location = 'login.html';
            })
            logout_operation()
        }
    }


    function logoutAll() {
        var logoutAll_confirm = confirm("Do you wish to logout from All Devices?")
        if (logoutAll_confirm) {
            const url = "https://8xmv9zllk6.execute-api.us-east-1.amazonaws.com/DEV/me/logoutall"
            document.getElementById("loader").style.display = "block";
            var logoutAll_operation = async () => await fetch(url, {
                Host: "8xmv9zllk6.execute-api.us-east-1.amazonaws.com",
                method: 'GET',
                headers: {
                    'Content-Type': 'application/text',
                    'Authorization': user_data.Token
                }
            }).then((res) => {
                return res.text().then((data) => {
                    alert("You Have successfully Logged out of all devices.")
                    delete_cookie("_sales24JWT")
                    window.location = 'index1.html';
                })
            }).catch((err) => {
                alert("Something went wrong. Please login Again")
                delete_cookie("_sales24JWT")
                window.location = 'login.html';
            })
            logoutAll_operation()
        }
    }

    var generateCard = async function (id, name, desc, price, location, src) {

        var elem = document.createElement('div');
        elem.className = "col-lg-3 col-md-4 col-6"
        var anch = document.createElement('a');
        anch.id = "id"
        anch.className = "d-block mb-4 h-100"
        anch.href = "adDetail.html?AD_ID=" + id

        var second_div = document.createElement('div')
        second_div.className = "w3-card-4"

        var second_para = document.createElement('p')
        second_para.innerHTML = name + "".italics()
        second_para.className = "text-lg-center"


        var image = document.createElement('img')
        image.className = "w3-image"
        image.id = id
        image.src = src
        image.alt = "avatar"

        var third_para = document.createElement('p')
        third_para.className = "text-lg-center"
        third_para.innerHTML = desc

        var fourth_para = document.createElement('p')
        fourth_para.className = "text-lg-center fa"
        fourth_para.innerHTML = "&#xf041;  " + location.bold()


        var fifth_para = document.createElement('p')
        fifth_para.className = "text-lg-center"
        fifth_para.innerHTML = "&#x20b9 " + price.bold()

        var i_element = document.createElement('button')
        i_element.className = "fa fa-heart"
        i_element.id = id + "heart"
        i_element.style.color = "grey"
        i_element.style.fontSize = 24
        i_element.onclick = function () { liked(id + "heart") };

        anch.appendChild(second_para)
        anch.appendChild(image)
        anch.appendChild(third_para)
        anch.appendChild(fourth_para)
        anch.appendChild(fifth_para)
        second_div.appendChild(anch)

        second_div.appendChild(i_element)
        elem.appendChild(second_div)


        document.getElementById("mainHead").appendChild(elem)
    }

    function liked(id) {
        var heart = document.getElementById(id)
        if (heart.style.color == "red") {
            heart.style.color = "grey"
            return
        }
        heart.style.color = "red"
    }

    var recentlyPostedAds = async () => {
        var body = "";
        if (sessionStorage.getItem('lastSearchedKey') && start == false) {
            body = JSON.stringify({ "lastScannedIndex": JSON.parse(sessionStorage.getItem('lastSearchedKey')) })
            sessionStorage.removeItem("lastSearchedKey");
        }
        var url = "https://8xmv9zllk6.execute-api.us-east-1.amazonaws.com/DEV/me/recentlypostedads"
        document.getElementById("mainHead").style.display = "block"
        document.getElementById("loader").style.display = "block";
        await fetch(url, {
            Host: "8xmv9zllk6.execute-api.us-east-1.amazonaws.com",
            method: 'POST', // or 'PUT',
            body
        }).then((res) => {
            if (res.status == 400) {
                document.getElementById("loader").style.display = "block";
                return res.text().then((data) => {
                    alert("Something went wrong. Please try again.")
                    document.getElementById("loader").style.display = "none";
                    document.getElementById("mainhead").style.display = "block"
                });
            }
            return res.text().then((data) => {
                document.getElementById("mainHead").style.display = "block";
                document.getElementById("loader").style.display = "block"
                console.log(data)
                var total_data = JSON.parse(data)
                console.log(total_data)
                if (total_data.LAST_KEY) {
                    sessionStorage.setItem('lastSearchedKey', JSON.stringify(total_data.LAST_KEY))
                    document.getElementById('searchMore').style.display = "block"
                    start = false
                }
                else {
                    document.getElementById('searchMore').style.display = "none"
                    document.getElementById('lastAd').style.display = "block"
                    start = true
                }
                total_data = total_data.ITEMS
                if (total_data.length == 0) {
                    document.getElementById("mainHead").style.display = "block";
                    document.getElementById("loader").style.display = "none"
                    document.getElementById("noAds").style.display = "block"
                    return;
                }
                if(starting){
                document.getElementById("mainHead").innerHTML = ""
                starting=false;
                }
                for (var i = 0; i < total_data.length; i++) {
                    generateCard(total_data[i].AD_KEY, total_data[i].PRODUCT_NAME, total_data[i].PRODUCT_DESCRIPTION, total_data[i].PRODUCT_PRICE, total_data[i].PRODUCT_LOCATION, total_data[i].S3_LOCATION)
                    console.log(i)
                    if (i == total_data.length - 1) {
                        document.getElementById("mainHead").style.display = "block";
                        document.getElementById("loader").style.display = "none"
                    }
                }
            })
        })
            .catch((err) => {
                alert("Something Went Wrong.")
                document.getElementById("loader").style.display = "none";
                document.getElementById("mainHead").style.display = "block"
                window.location = "index1.html"
            })

    }


    var categoryStart = true
    var postByCategory = async (category) => {
        var body = JSON.stringify({ "lastScannedIndex": false, category });
        if (sessionStorage.getItem('lastSearchedKey') && categoryStart == false) {
            body = JSON.stringify({ "lastScannedIndex": JSON.parse(sessionStorage.getItem('lastSearchedKey')), category })
            sessionStorage.removeItem("lastSearchedKey");
        }
        var url = "https://8xmv9zllk6.execute-api.us-east-1.amazonaws.com/DEV/adspostedbycategory"
        document.getElementById("mainHead").style.display = "block"
        document.getElementById("loader").style.display = "block";
        await fetch(url, {
            Host: "8xmv9zllk6.execute-api.us-east-1.amazonaws.com",
            method: 'POST', // or 'PUT',
            body
        }).then((res) => {
            if (res.status == 400) {
                document.getElementById("mainHead").style.display = "block";
                document.getElementById("loader").style.display = "block";
                return res.text().then((data) => {
                    alert("Something went wrong. Please try again.")
                    document.getElementById("loader").style.display = "none";
                    document.getElementById("mainHead").style.display = "block"
                });
            }
            return res.text().then((data) => {
                document.getElementById("mainHead").style.display = "block";
                document.getElementById("loader").style.display = "block"
                var total_data = JSON.parse(data)
                total_data = total_data.ITEMS
                if (total_data.length == 0) {
                    document.getElementById("mainHead").style.display = "block";
                    document.getElementById("loader").style.display = "none"
                    document.getElementById("lastAd").style.display = "block"
                    return;
                }
                if(starting){
                document.getElementById("mainHead").innerHTML="";
                starting=false;
                }
                for (var i = 0; i < total_data.length; i++) {
                    generateCard(total_data[i].AD_KEY, total_data[i].PRODUCT_NAME, total_data[i].PRODUCT_DESCRIPTION, total_data[i].PRODUCT_PRICE, total_data[i].PRODUCT_LOCATION, total_data[i].S3_LOCATION, "mainHeadCategory")

                    if (i == total_data.length - 1) {
                        document.getElementById("mainHead").style.display = "block";
                        document.getElementById("loader").style.display = "none"
                    }
                    if (i == 3) {
                        document.getElementById("mainHead").style.display = "block";
                        document.getElementById("loader").style.display = "none"
                        if (total_data.length > i) {
                            document.getElementById("searchMore").style.display = "block"
                        }
                        break
                    }
                }
                if (total_data.length < 3) {
                    document.getElementById('lastAd').style.display = "block"
                }
            })
        })
            .catch((err) => {
                alert("Something Went Wrong.")
                document.getElementById("loader").style.display = "none";
                document.getElementById("mainHead").style.display = "block"
                window.location="index1.html"
            })

    }


    const params = new URLSearchParams(document.location.search);
    const adId = params.get("key");
    const category=params.get("category")
    document.getElementById('productCategory').addEventListener('change', (e) => {
        e.preventDefault()
        var category = document.getElementById('productCategory').value
        document.getElementById('mainHead').innerHTML = ""
        postByCategory(category)
    })
    if (adId == 'recent') {
        document.getElementById("pageHeading").innerText="Recently Posted ADs"
        recentlyPostedAds()
    }
    else if(category){
        var all_categories=["Electronics","Fashion","Home Appliances","Two Wheeler","Four Wheeler","Other"]
        var flag=false
        all_categories.filter((array_category)=>{
            if(array_category==category){
                flag=true
            }
        })
        if(!flag){
            alert("Searched Category not available")
            window.location="index1.html"
        }
        document.getElementById("productCategoryDiv").style.display="block"
        document.getElementById("pageHeading").innerText="ADs Posted in "+category
        postByCategory(category)
    }
    else{
        alert("Could not find page.")
        window.location="index1.html"
    }

</script>

</html>